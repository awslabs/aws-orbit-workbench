AWSTemplateFormatVersion: '2010-09-09'
Description: |
  DataMaker Toolkit Stack - ${env_name}
Resources:
  Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: datamaker-${env_name}-toolkit-${account_id}-${deploy_id}
      Tags: 
        - Key: Env
          Value: datamaker-${env_name}
      VersioningConfiguration:
        Status: Suspended
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: CleaningUp
            Status: Enabled
            ExpirationInDays: 1
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
            NoncurrentVersionExpirationInDays: 1
            Prefix: cli/remote/
  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: datamaker-toolkit-${env_name}-codebuild
      AssumeRolePolicyDocument:
        Statement:
        - Action: ['sts:AssumeRole']
          Effect: Allow
          Principal:
            Service: [codebuild.amazonaws.com]
        Version: '2012-10-17'
      Path: /
      Policies:
        - PolicyName: CodeBuildAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:*
                  - kms:CreateKey
                  - secretsmanager:GetRandomPassword
                  - ecr:GetAuthorizationToken
                  - ecr:DescribeRepositories
                  - ecr:ListTagsForResource
                  - cloudformation:ListStacks
                  - elasticfilesystem:CreateFileSystem
                  - elasticfilesystem:CreateMountTarget
                  - elasticfilesystem:DescribeFileSystems
                  - elasticfilesystem:DeleteMountTarget
                  - elasticfilesystem:DescribeMountTargets
                  - elasticfilesystem:DeleteFileSystem
                  - iam:ListAttachedRolePolicies
                  - iam:GetPolicy
                  - iam:ListPolicyVersions
                  - iam:GetRole
                  - iam:GetRolePolicy
                  - iam:ListRoleTags
                  - iam:GetOpenIDConnectProvider
                  - cognito-idp:CreateUserPool
                  - cognito-idp:DeleteUserPool
                  - cognito-idp:CreateUserPoolClient
                  - cognito-idp:DeleteUserPoolClient
                  - cognito-idp:CreateGroup
                  - cognito-idp:DeleteGroup
                  - cognito-identity:CreateIdentityPool
                  - cognito-identity:DeleteIdentityPool
                  - cognito-identity:UntagResource
                  - cognito-identity:TagResource
                  - cognito-identity:SetIdentityPoolRoles
                  - ec2:*
                  - elasticloadbalancing:*
                Resource: '*'
              - Effect: Allow
                Action:
                  - s3:*
                Resource:
                  - arn:aws:s3:::datamaker-${env_name}-toolkit-${account_id}-${deploy_id}/*
                  - arn:aws:s3:::datamaker-${env_name}-toolkit-${account_id}-${deploy_id}
              - Effect: Allow
                Action:
                    - codebuild:CreateReportGroup
                    - codebuild:CreateReport
                    - codebuild:UpdateReport
                    - codebuild:BatchPutTestCases
                    - codebuild:BatchPutCodeCoverages
                Resource:
                  - arn:aws:codebuild:*
              - Effect: Allow
                Action:
                    - codebuild:StartBuild
                    - codebuild:BatchGetBuilds
                Resource:
                  - arn:aws:codebuild:${region}:${account_id}:project/datamaker-${env_name}
              - Effect: Allow
                Action:
                    - ecr:*
                Resource:
                  - arn:aws:ecr:${region}:${account_id}:repository/datamaker-${env_name}-*
              - Effect: Allow
                Action:
                  - cloudformation:*
                Resource:
                  - arn:aws:cloudformation:${region}:${account_id}:stack/datamaker-${env_name}*
                  - arn:aws:cloudformation:${region}:${account_id}:stack/eksctl-datamaker-${env_name}*
              - Effect: Allow
                Action:
                  - iam:CreateRole
                  - iam:AttachRolePolicy
                  - iam:PutRolePolicy
                  - iam:DetachRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:DeleteRole
                  - iam:UntagRole
                  - iam:TagRole
                  - iam:PassRole
                  - iam:ListAttachedRolePolicies
                  - iam:UpdateAssumeRolePolicy
                Resource:
                  - arn:aws:iam::${account_id}:role/datamaker-${env_name}-*
              - Effect: Allow
                Action:
                  - iam:CreateServiceLinkedRole
                Resource:
                  - arn:aws:iam::${account_id}:role/aws-service-role/eks-nodegroup.amazonaws.com/AWSServiceRoleForAmazonEKSNodegroup
              - Effect: Allow
                Action:
                  - iam:CreatePolicy
                  - iam:DeletePolicy
                Resource:
                  - arn:aws:iam::${account_id}:policy/datamaker-${env_name}-*
              - Effect: Allow
                Action:
                  - ssm:GetParameters
                  - ssm:DescribeParameters
                  - ssm:GetParameter
                  - ssm:DescribeParameter
                  - ssm:PutParameter
                  - ssm:AddTagsToResource
                  - ssm:DeleteParameter
                Resource:
                  - arn:aws:ssm:${region}:${account_id}:parameter/datamaker/${env_name}/manifest
                  - arn:aws:ssm:${region}:${account_id}:parameter/datamaker/${env_name}/teams/*
              - Effect: Allow
                Action:
                  - kms:*
                Resource:
                  - arn:aws:kms:${region}:${account_id}:alias/datamaker-{env_name}*
                  - arn:aws:kms:${region}:${account_id}:key/*
              - Effect: Allow
                Action:
                  - secretsmanager:*
                Resource:
                  - arn:aws:secretsmanager:${region}:${account_id}:secret:datamaker-${env_name}*
              - Effect: Allow
                Action:
                  - eks:*
                Resource:
                  - arn:aws:eks:${region}:${account_id}:cluster/datamaker-${env_name}
                  - arn:aws:eks:${region}:${account_id}:nodegroup/datamaker-${env_name}/*



  CodeBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: datamaker-${env_name}
      Tags: 
        - Key: Env
          Value: datamaker-${env_name}
      Description: DataMaker CLI backend.
      ServiceRole: !Ref CodeBuildRole
      Artifacts:
        Type: NO_ARTIFACTS
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_MEDIUM
        Image: aws/codebuild/standard:4.0
      Source:
        Type: NO_SOURCE
        BuildSpec:  |
          version: 0.2
          phases:
            install:
              runtime-versions:
                python: 3.7
                nodejs: 12
            build:
              commands:
                - ls -la
      TimeoutInMinutes: 20
      LogsConfig:
        CloudWatchLogs: 
          Status: ENABLED
          GroupName: /aws/codebuild/datamaker-${env_name}
        S3Logs: 
          Status: DISABLED
  KmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: alias/datamaker-${env_name}-${deploy_id}
      TargetKeyId:
        Ref: KmsKey
  KmsKey:
    Type: AWS::KMS::Key
    Properties:
      Tags:
        - Key: Env
          Value: datamaker-${env_name}
      Description: DataMaker key for ${env_name}.
      KeyPolicy:
        Version: '2012-10-17'
        Id: datamaker-${env_name}
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: arn:aws:iam::${account_id}:root
            Action: kms:*
            Resource: '*'
          - Sid: Allow administration of the key
            Effect: Allow
            Principal:
              AWS:
                Ref: AWS::AccountId
            Action:
              - kms:Create*
              - kms:Describe*
              - kms:Enable*
              - kms:List*
              - kms:Put*
              - kms:Update*
              - kms:Revoke*
              - kms:Disable*
              - kms:Get*
              - kms:Delete*
              - kms:ScheduleKeyDeletion
              - kms:CancelKeyDeletion
            Resource: '*'
Outputs:
  DeployId:
    Value: ${deploy_id}
    Export:
      Name: datamaker-${env_name}-deploy-id
  KmsKeyArn:
    Value:
      Fn::GetAtt:
        - KmsKey
        - Arn
    Export:
      Name: datamaker-${env_name}-kms-arn

AWSTemplateFormatVersion: '2010-09-09'
Description: |
  DataMaker Toolkit Stack - ${env_name}
Resources:
  Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: datamaker-${env_name}-toolkit-${account_id}
      Tags: 
        - Key: Env
          Value: datamaker-${env_name}
      VersioningConfiguration:
        Status: Suspended
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: CleaningUp
            Status: Enabled
            ExpirationInDays: 1
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 1
            NoncurrentVersionExpirationInDays: 1
  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: datamaker-toolkit-${env_name}-codebuild
      AssumeRolePolicyDocument:
        Statement:
        - Action: ['sts:AssumeRole']
          Effect: Allow
          Principal:
            Service: [codebuild.amazonaws.com]
        Version: '2012-10-17'
      Path: /
      Policies:
        - PolicyName: CodeBuildAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:*
                  - cloudformation:ListStacks
                  - elasticfilesystem:CreateFileSystem
                  - elasticfilesystem:CreateMountTarget
                  - elasticfilesystem:DescribeFileSystems
                  - elasticfilesystem:DeleteMountTarget
                  - elasticfilesystem:DescribeMountTargets
                  - iam:GetPolicy
                  - iam:ListPolicyVersions
                  - iam:GetRole
                  - iam:GetRolePolicy
                  - iam:ListRoleTags
                  - iam:GetOpenIDConnectProvider
                  - cognito-idp:CreateUserPool
                  - cognito-idp:DeleteUserPool
                  - cognito-idp:CreateUserPoolClient
                  - cognito-idp:DeleteUserPoolClient
                  - cognito-idp:CreateGroup
                  - cognito-idp:DeleteGroup
                  - cognito-identity:CreateIdentityPool
                  - cognito-identity:DeleteIdentityPool
                  - cognito-identity:UntagResource
                  - cognito-identity:TagResource
                  - cognito-identity:SetIdentityPoolRoles
                  - ec2:*
                  - elasticloadbalancing:*
                Resource: '*'
              - Effect: Allow
                Action:
                  - s3:*
                Resource:
                  - arn:aws:s3:::datamaker-${env_name}-toolkit-${account_id}/*
                  - arn:aws:s3:::datamaker-${env_name}-toolkit-${account_id}
              - Effect: Allow
                Action:
                    - codebuild:CreateReportGroup
                    - codebuild:CreateReport
                    - codebuild:UpdateReport
                    - codebuild:BatchPutTestCases
                    - codebuild:BatchPutCodeCoverages
                Resource:
                  - arn:aws:codebuild:*
              - Effect: Allow
                Action:
                  - cloudformation:*
                Resource:
                  - arn:aws:cloudformation:${region}:${account_id}:stack/datamaker-${env_name}*
                  - arn:aws:cloudformation:${region}:${account_id}:stack/eksctl-datamaker-${env_name}*
              - Effect: Allow
                Action:
                  - iam:CreateRole
                  - iam:AttachRolePolicy
                  - iam:PutRolePolicy
                  - iam:DetachRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:DeleteRole
                  - iam:UntagRole
                  - iam:TagRole
                  - iam:PassRole
                  - iam:ListAttachedRolePolicies
                Resource:
                  - arn:aws:iam::${account_id}:role/datamaker-${env_name}-*
              - Effect: Allow
                Action:
                  - iam:CreatePolicy
                  - iam:DeletePolicy
                Resource:
                  - arn:aws:iam::${account_id}:policy/datamaker-${env_name}-*
              - Effect: Allow
                Action:
                  - ssm:GetParameters
                  - ssm:DescribeParameters
                  - ssm:GetParameter
                  - ssm:DescribeParameter
                  - ssm:PutParameter
                  - ssm:AddTagsToResource
                  - ssm:DeleteParameter
                Resource:
                  - arn:aws:ssm:${region}:${account_id}:parameter/datamaker/${env_name}/manifest
                  - arn:aws:ssm:${region}:${account_id}:parameter/datamaker/${env_name}/teams/*
              - Effect: Allow
                Action:
                  - eks:*
                Resource:
                  - arn:aws:eks:${region}:${account_id}:cluster/datamaker-${env_name}
                  - arn:aws:eks:${region}:${account_id}:nodegroup/datamaker-${env_name}/*
              - Effect: Allow
                Action:
                  - route53:CreateHostedZone
                  - route53:ListQueryLoggingConfigs
                  - route53:GetChange
                  - route53:GetHostedZone
                  - route53:DeleteHostedZone
                  - route53:ChangeTagsForResource
                  - route53:ChangeResourceRecordSets
                Resource: '*'
                #Resource:
                 # - arn:aws:route53:::hostedzone/Z05690743TFR3EKY7TJ6L
                 # - arn:aws:route53:::change/C07725951JH15K6IHM249


  CodeBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: datamaker-${env_name}
      Tags: 
        - Key: Env
          Value: datamaker-${env_name}
      Description: DataMaker CLI backend.
      ServiceRole: !Ref CodeBuildRole
      Artifacts:
        Type: NO_ARTIFACTS
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_MEDIUM
        Image: aws/codebuild/standard:4.0
      Source:
        Type: NO_SOURCE
        BuildSpec:  |
          version: 0.2
          phases:
            install:
              runtime-versions:
                python: 3.7
                nodejs: 12
            build:
              commands:
                - ls -la
      TimeoutInMinutes: 20
      LogsConfig:
        CloudWatchLogs: 
          Status: ENABLED
          GroupName: /aws/codebuild/datamaker-${env_name}
        S3Logs: 
          Status: DISABLED
